<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大老二-真實 (Big Two: The Reality)</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-back: #2c3e50;
            --primary: #e74c3c;
            --secondary: #3498db;
            --text: #ecf0f1;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        #game-info { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; width: 80%; max-width: 800px; text-align: center; border: 1px solid #555; }
        .reality-hidden { color: #f1c40f; font-weight: bold; font-size: 1.2em; }
        .status-msg { margin: 10px 0; color: #3498db; min-height: 24px; }
        #player-area { width: 90%; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 30px; }
        .card { width: 60px; height: 90px; background: white; color: black; border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 2px solid transparent; user-select: none; transition: transform 0.2s; }
        .card.selected { border-color: var(--primary); transform: translateY(-10px); }
        .card.red { color: #e74c3c; }
        .card-num { font-size: 1.5em; font-weight: bold; }
        #controls { margin-top: 20px; display: flex; gap: 10px; }
        button { padding: 10px 20px; font-size: 1em; cursor: pointer; border: none; border-radius: 5px; background: var(--secondary); color: white; transition: 0.3s; }
        button:disabled { background: #555; cursor: not-allowed; }
        button:hover:not(:disabled) { opacity: 0.8; }
        .rule-select { margin-bottom: 15px; display: none; }
        #game-log { width: 80%; max-width: 800px; height: 150px; background: #000; overflow-y: auto; padding: 10px; font-size: 0.9em; color: #aaa; margin-top: 20px; border: 1px solid #444; }
    </style>
</head>
<body>

<h1>大老二-真實</h1>

<div id="game-info">
    <div>當前「真實」：<span class="reality-hidden">尚未揭曉（封印中）</span></div>
    <div id="current-rule-display">當前規則：等待開局</div>
    <div class="status-msg" id="status-msg">請輸入玩家人數開始遊戲</div>
</div>

<div id="setup-area">
    <input type="number" id="player-count" value="4" min="2" max="6">
    <button onclick="startGame()">開始遊戲</button>
</div>

<div class="rule-select" id="rule-selector">
    <label>請選擇此輪基準：</label>
    <button onclick="setRule('proximity')">數量鄰近</button>
    <button onclick="setRule('suit')">花色一致</button>
</div>

<div id="player-area"></div>

<div id="controls" style="display:none;">
    <button id="play-btn" onclick="playHand()">出牌</button>
    <button id="pass-btn" onclick="passTurn()">Pass</button>
</div>

<div id="game-log"></div>

<script>
    const SUITS = ['♠', '♥', '♦', '♣'];
    const RANKS = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13'];
    const SUIT_COLORS = { '♠': 'black', '♥': 'red', '♦': 'red', '♣': 'black' };

    let deck = [];
    let players = [];
    let currentPlayerIndex = 0;
    let realityCard = null;
    let lastHand = null;
    let currentRule = null; // 'proximity' or 'suit'
    let currentHandType = null; // 'single', 'pair', etc.
    let tryCount = 0;
    let passCount = 0;
    let gameEnded = false;
    let winners = [];

    function log(msg) {
        const logDiv = document.getElementById('game-log');
        logDiv.innerHTML += `<div>> ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function createDeck() {
        let d = [];
        for (let s of SUITS) {
            for (let r of RANKS) {
                d.push({ suit: s, rank: parseInt(r) });
            }
        }
        return d.sort(() => Math.random() - 0.5);
    }

    function startGame() {
        const n = parseInt(document.getElementById('player-count').value);
        if (n < 2) return alert("至少需要2人");
        
        let fullDeck = createDeck();
        realityCard = fullDeck.pop(); // 挑出一張作為真實
        
        const cardsPerPlayer = Math.floor(51 / n);
        players = [];
        for (let i = 0; i < n; i++) {
            players.push({
                id: i + 1,
                hand: fullDeck.splice(0, cardsPerPlayer),
                active: true
            });
        }

        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('controls').style.display = 'flex';
        currentPlayerIndex = Math.floor(Math.random() * n);
        
        log(`遊戲開始！「真實」已選定。由 玩家 ${currentPlayerIndex + 1} 開局。`);
        startNewRound();
    }

    function startNewRound() {
        lastHand = null;
        currentRule = null;
        currentHandType = null;
        passCount = 0;
        document.getElementById('rule-selector').style.display = 'block';
        updateUI();
    }

    function setRule(rule) {
        currentRule = rule;
        document.getElementById('rule-selector').style.display = 'none';
        document.getElementById('current-rule-display').innerText = `當前規則：${rule === 'proximity' ? '數量鄰近' : '花色一致'}`;
        updateUI();
    }

    function renderHand() {
        const area = document.getElementById('player-area');
        area.innerHTML = '';
        const p = players[currentPlayerIndex];
        
        document.getElementById('status-msg').innerText = `輪到玩家 ${p.id} (剩餘 ${p.hand.length} 張)`;
        
        p.hand.sort((a,b) => a.rank - b.rank).forEach((card, index) => {
            const cardEl = document.createElement('div');
            cardEl.className = `card ${SUIT_COLORS[card.suit]}`;
            cardEl.innerHTML = `<div class="card-num">${card.rank}</div><div>${card.suit}</div>`;
            cardEl.onclick = () => {
                cardEl.classList.toggle('selected');
            };
            cardEl.dataset.idx = index;
            area.appendChild(cardEl);
        });
    }

    function getSelectedCards() {
        const selectedEls = document.querySelectorAll('.card.selected');
        const p = players[currentPlayerIndex];
        return Array.from(selectedEls).map(el => p.hand[el.dataset.idx]);
    }

    function getHandType(cards) {
        if (cards.length === 1) return 'single';
        if (cards.length === 2 && cards[0].rank === cards[1].rank) return 'pair';
        if (cards.length === 3 && cards[0].rank === cards[1].rank && cards[1].rank === cards[2].rank) return 'triple';
        if (cards.length === 5) {
            const counts = {};
            cards.forEach(c => counts[c.rank] = (counts[c.rank] || 0) + 1);
            const vals = Object.values(counts);
            if (vals.includes(3) && vals.includes(2)) return 'fullhouse';
            if (vals.includes(4)) return 'fourkind';
            // 簡化版順子判斷
            const ranks = cards.map(c => c.rank).sort((a,b) => a-b);
            if (ranks[4] - ranks[0] === 4) return 'straight';
        }
        return null;
    }

    function playHand() {
        const selected = getSelectedCards();
        const type = getHandType(selected);

        if (!type) {
            alert("無效的牌型！");
            return;
        }

        // 第一手決定牌型
        if (!lastHand) {
            if (!currentRule) { alert("請先選擇本輪規則基準"); return; }
            currentHandType = type;
            executeMove(selected);
            return;
        }

        // 檢查規則一致性
        if (type !== currentHandType) {
            alert(`牌型不符！這輪必須出 ${currentHandType}`);
            return;
        }

        // 真實判斷邏輯
        let isValid = false;
        if (currentRule === 'proximity') {
            const currentDist = Math.abs(selected[0].rank - realityCard.rank);
            const lastDist = Math.abs(lastHand[0].rank - realityCard.rank);
            if (currentDist < lastDist) isValid = true;
        } else if (currentRule === 'suit') {
            const hasSameSuit = selected.some(c => c.suit === realityCard.suit);
            if (hasSameSuit && selected[0].rank > lastHand[0].rank) isValid = true;
        }

        if (isValid) {
            tryCount = 0;
            executeMove(selected);
        } else {
            tryCount++;
            alert(`不符合「真實」規律！剩餘機會: ${2 - tryCount}`);
            if (tryCount >= 2) {
                tryCount = 0;
                passTurn();
            }
        }
    }

    function executeMove(selected) {
        const p = players[currentPlayerIndex];
        lastHand = selected;
        // 從手牌移除
        selected.forEach(sc => {
            const idx = p.hand.findIndex(hc => hc.rank === sc.rank && hc.suit === sc.suit);
            p.hand.splice(idx, 1);
        });

        log(`玩家 ${p.id} 出了 ${selected.map(c => c.suit + c.rank).join(', ')}`);
        
        if (p.hand.length === 0) {
            log(`★ 玩家 ${p.id} 獲勝！`);
            winners.push(p.id);
            players.splice(currentPlayerIndex, 1);
            if (players.length === 0) {
                endGame();
                return;
            }
            currentPlayerIndex %= players.length;
        } else {
            nextPlayer();
        }
        passCount = 0;
        updateUI();
    }

    function passTurn() {
        log(`玩家 ${players[currentPlayerIndex].id} 跳過`);
        passCount++;
        nextPlayer();
        
        if (passCount >= players.length - 1 && players.length > 0) {
            log(`所有玩家 Pass。玩家 ${players[currentPlayerIndex].id} 重新開局。`);
            startNewRound();
        } else {
            updateUI();
        }
    }

    function nextPlayer() {
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
    }

    function updateUI() {
        if (gameEnded) return;
        renderHand();
    }

    function endGame() {
        gameEnded = true;
        document.getElementById('player-area').innerHTML = "<h2>遊戲結束</h2>";
        document.getElementById('controls').style.display = 'none';
        const realityEl = document.querySelector('.reality-hidden');
        realityEl.innerText = `${realityCard.suit} ${realityCard.rank}`;
        realityEl.style.color = '#2ecc71';
        log(`牌局最終揭曉！真實是：${realityCard.suit} ${realityCard.rank}`);
        log(`排名：${winners.join(' -> ')}`);
    }
</script>

</body>
</html>
