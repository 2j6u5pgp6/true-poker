<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çœŸå¯¦å¤§è€äºŒ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --gold: #d4af37; --bg: #0a0a0a; --card-bg: #eee; }
        * { box-sizing: border-box; }
        
        body { 
            background: var(--bg); color: #b8a07e; 
            font-family: -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
            margin: 0; padding: 0; display: flex; flex-direction: column; 
            height: 100vh; height: -webkit-fill-available; overflow: hidden;
        }

        /* è¨­ç½®ä»‹é¢ */
        .setup-overlay { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.95); 
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; z-index: 100; padding: 20px; text-align: center; 
        }

        /* é ‚éƒ¨å€åŸŸ */
        .dealer-bar { background: #000; padding: 5px; border-bottom: 2px solid #333; text-align: center; flex-shrink: 0; }
        #noumena-card { 
            width: 45px; height: 60px; background: #111; border: 1px solid #444; 
            margin: 5px auto; line-height: 60px; font-size: 20px; color: transparent; 
            border-radius: 5px; transition: 1.5s; 
        }
        #noumena-card.reveal { background: var(--card-bg); color: #000; border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }

        /* éŠæˆ²ä¸»ç«¶æŠ€å ´ */
        .arena { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; min-height: 0; padding: 10px; }
        
        #players-info { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; max-width: 100%; }
        .player-box { 
            border: 1px solid #333; padding: 4px 8px; background: #151515; 
            font-size: 10px; border-radius: 4px; min-width: 60px; text-align: center;
        }
        .player-box.active { border-color: var(--gold); color: #fff; box-shadow: 0 0 8px var(--gold); }
        .player-box.finished { opacity: 0.3; text-decoration: line-through; }

        .table-center { 
            width: 95%; max-width: 450px; height: 140px; border: 2px solid #222; 
            border-radius: 70px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
        }

        /* å¡ç‰Œæ¨£å¼ */
        .card { 
            width: 35px; height: 50px; background: var(--card-bg); color: #000; 
            border-radius: 4px; display: inline-block; margin: 2px; 
            line-height: 50px; font-weight: bold; font-size: 14px; text-align: center; border: 1px solid #888; 
        }
        .card.red { color: #c00; }

        /* æ‰‹ç‰Œå€åŸŸ - æ‰‹æ©Ÿç‰ˆé‡é»å„ªåŒ– */
        .hand-zone { background: #111; padding: 10px; border-top: 2px solid #333; flex-shrink: 0; }
        #my-hand { 
            display: flex; flex-wrap: wrap; justify-content: center; 
            gap: 4px; max-height: 120px; overflow-y: auto; padding-bottom: 5px;
        }
        .my-card { cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .my-card.selected { border: 2px solid var(--gold); transform: translateY(-8px); background: #fff; }

        /* æ§åˆ¶æŒ‰éˆ• */
        .controls { display: flex; justify-content: center; gap: 6px; padding: 5px 0; }
        button { 
            background: #1a1a1a; color: var(--gold); border: 1px solid #444; 
            padding: 10px 12px; cursor: pointer; border-radius: 5px; font-size: 13px; font-weight: bold;
        }
        button:active { background: var(--gold); color: #000; }
        button:disabled { opacity: 0.2; }

        #log { height: 60px; overflow-y: scroll; background: #000; padding: 8px; font-size: 10px; color: #666; border-top: 1px solid #222; }

        /* æ‰‹æ©Ÿç‰ˆå°ºå¯¸å¾®èª¿ */
        @media (max-width: 480px) {
            .table-center { height: 120px; }
            .card { width: 32px; height: 46px; line-height: 46px; font-size: 12px; }
            button { padding: 12px 10px; font-size: 12px; flex: 1; }
            #display-id { font-size: 14px; word-break: break-all; }
        }
    </style>
</head>
<body>

<div id="setup-screen" class="setup-overlay">
    <h2 style="color:var(--gold); margin-bottom: 5px;">çœŸå¯¦å¤§è€äºŒ</h2>
    <p style="font-size: 12px; margin-bottom: 20px;">è·¨è£ç½®å¤šäººåœ¨ç·šç‰ˆ</p>
    <div id="init-btns">
        <button onclick="initHost()">å‰µç«‹æˆ¿é–“ (æˆ¿é•·)</button><br><br>
        <button onclick="showJoinInput()">åŠ å…¥æˆ¿é–“ (ç©å®¶)</button>
    </div>
    <div id="host-zone" style="display:none;">
        <p>æˆ¿é•· ID (é»æ“Šè¤‡è£½):<br> <b id="display-id" style="color:var(--gold); cursor:pointer;" onclick="copyID()">æ­£åœ¨ç”Ÿæˆ...</b></p>
        <p style="font-size: 12px;">å·²é€£ç·šï¼š<span id="peer-count">0</span> äºº</p>
        <button onclick="startMultiplayerGame()" id="start-btn" disabled>ç­‰å¾…ç©å®¶...</button>
    </div>
    <div id="join-zone" style="display:none;">
        <input type="text" id="join-id" placeholder="è²¼ä¸Šæˆ¿é•· ID" style="padding:12px; width:80%; max-width:250px; margin-bottom:15px; background:#000; color:#fff; border:1px solid #444;">
        <button onclick="connectToHost()">ç¢ºèªé€£ç·š</button>
    </div>
</div>

<div class="dealer-bar">
    <div id="noumena-card">?</div>
    <div style="font-size:10px; opacity:0.5;">çœŸå¯¦</div>
</div>

<div class="arena">
    <div id="players-info"></div>
    <div class="table-center">
        <div id="table-cards"></div>
        <div id="table-info" style="font-size:11px; color:var(--gold); margin-top:5px;">ç­‰å¾…é–‹å±€</div>
    </div>
</div>

<div id="log"></div>

<div class="hand-zone">
    <div id="my-hand"></div>
    <div class="controls">
        <button id="btn-dist" onclick="sendAction('PLAY', 'DIST')" disabled>æ•¸å€¼é„°è¿‘</button>
        <button id="btn-suit" onclick="sendAction('PLAY', 'SUIT')" disabled>èŠ±è‰²ä¸€è‡´</button>
        <button id="btn-pass" onclick="sendAction('PASS')" disabled>PASS</button>
    </div>
    <div id="status-indicator" style="text-align:center; font-size:11px; margin-top:5px; color:var(--gold)"></div>
</div>

<script>
    // æ ¸å¿ƒéŠæˆ²é‚è¼¯ (èˆ‡å‰ç‰ˆä¸€è‡´ï¼Œä½†å¢åŠ äº†å…¨å“¡å®Œè³½æ‰é¡¯ç¾çš„åˆ¤æ–·)
    const SUITS = ['â™ ','â™¥','â™¦','â™£'], VALUES = [1,2,3,4,5,6,7,8,9,10,11,12,13];
    let peer, conn, connections = [], isHost = false;
    let myId, myCards = [], currentTurnIdx = 0, selectedIdxs = [];
    let gameState = { players: [], table: { cards: [], power: -1, rule: "", type: null, leaderId: -1 }, secret: null };

    function initHost() {
        isHost = true;
        peer = new Peer();
        peer.on('open', id => {
            document.getElementById('display-id').innerText = id;
            document.getElementById('init-btns').style.display = 'none';
            document.getElementById('host-zone').style.display = 'block';
        });
        peer.on('connection', c => {
            connections.push(c);
            document.getElementById('peer-count').innerText = connections.length;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('start-btn').innerText = "é–‹å§‹éŠæˆ²";
            c.on('data', data => handleData(data, c));
        });
    }

    function showJoinInput() {
        document.getElementById('init-btns').style.display = 'none';
        document.getElementById('join-zone').style.display = 'block';
    }

    function connectToHost() {
        const hostId = document.getElementById('join-id').value;
        peer = new Peer();
        peer.on('open', id => {
            myId = id;
            conn = peer.connect(hostId);
            conn.on('open', () => {
                document.getElementById('setup-screen').innerHTML = "<h3>é€£ç·šæˆåŠŸ</h3><p>ç­‰å¾…æˆ¿é•·ç™¼ç‰Œ...</p>";
                conn.on('data', data => handleData(data));
            });
        });
    }

    function startMultiplayerGame() {
        let deck = [];
        SUITS.forEach(s => VALUES.forEach(v => deck.push({val:v, suit:s, label:v===1?'A':v===11?'J':v===12?'Q':v===13?'K':v})));
        const sIdx = Math.floor(Math.random() * deck.length);
        gameState.secret = deck.splice(sIdx, 1)[0];
        deck.sort(() => Math.random() - 0.5);

        const n = connections.length + 1;
        const per = Math.floor(51 / n);
        gameState.players = [{ id: peer.id, name: "æˆ¿é•·", cards: deck.splice(0, per).sort((a,b)=>a.val-b.val), finished: false }];
        
        connections.forEach((c, i) => {
            const pCards = deck.splice(0, per).sort((a,b)=>a.val-b.val);
            gameState.players.push({ id: c.peer, name: `ç©å®¶ ${i+1}`, cards: pCards, finished: false });
            c.send({ type: 'INIT', gameState, yourId: c.peer });
        });

        broadcast({ type: 'UPDATE', gameState });
        document.getElementById('setup-screen').style.display = 'none';
        syncUI();
    }

    function handleData(data, fromConn) {
        if (data.type === 'INIT') { gameState = data.gameState; myId = data.yourId; document.getElementById('setup-screen').style.display = 'none'; syncUI(); }
        if (data.type === 'UPDATE') { gameState = data.gameState; syncUI(); }
        if (data.type === 'PLAY' && isHost) autoJudge(data);
        if (data.type === 'PASS' && isHost) nextTurn();
        if (data.type === 'FAIL') log("åˆ¤å®šå¤±æ•—ï¼Œè«‹å˜—è©¦å…¶ä»–ç‰Œå‹æˆ–è¦å‰‡ã€‚");
        if (data.type === 'LOG') log(data.msg);
        if (data.type === 'REVEAL') revealNoumena(data.secret);
    }

    function autoJudge(data) {
        const player = gameState.players[currentTurnIdx];
        const power = calculatePower(data.cards, data.rule, gameState.secret);
        const mType = getMoveType(data.cards);
        const isTypeOk = mType && (!gameState.table.type || mType === gameState.table.type);
        
        if (isTypeOk && power > gameState.table.power) {
            gameState.table = { cards: data.cards, power: power, rule: data.rule, type: mType, leaderId: player.id };
            player.cards = player.cards.filter(c => !data.cards.some(dc => dc.val === c.val && dc.suit === c.suit));
            broadcast({ type: 'LOG', msg: `${player.name} æˆåŠŸå‡ºç‰Œ` });
            
            if (player.cards.length === 0) player.finished = true;
            
            if (gameState.players.every(p => p.finished)) {
                broadcast({ type: 'REVEAL', secret: gameState.secret });
            } else {
                nextTurn();
            }
        } else {
            const target = connections.find(c => c.peer === player.id);
            if (target) target.send({ type: 'FAIL' }); else if (isHost) handleData({ type: 'FAIL' });
        }
    }

    function calculatePower(cards, rule, secret) {
        if (rule === 'DIST') return cards.reduce((acc, c) => acc + (14 - Math.abs(c.val - secret.val)), 0) / cards.length;
        if (rule === 'SUIT') return cards.every(c => c.suit === secret.suit) ? 100 + Math.max(...cards.map(c => c.val)) : -1;
        return -1;
    }

    function getMoveType(cards) {
        if (cards.length === 1) return 'å–®å¼µ';
        const isSame = cards.every(c => c.val === cards[0].val);
        if (cards.length === 2 && isSame) return 'å°å­';
        if (cards.length === 3 && isSame) return 'ä¸‰æ¢';
        if (cards.length === 4 && isSame) return 'éµæ”¯';
        return null;
    }

    function syncUI() {
        const myActualId = isHost ? peer.id : myId;
        const me = gameState.players.find(p => p.id === myActualId);
        if (!me) return;
        myCards = me.cards;
        const isMyTurn = gameState.players[currentTurnIdx]?.id === myActualId;
        
        document.getElementById('btn-dist').disabled = !isMyTurn || me.finished;
        document.getElementById('btn-suit').disabled = !isMyTurn || me.finished;
        document.getElementById('btn-pass').disabled = !isMyTurn || me.finished || gameState.table.leaderId === -1;
        document.getElementById('status-indicator').innerText = me.finished ? "å®Œè³½è§€å¯Ÿä¸­" : (isMyTurn ? "â˜… ä½ çš„å›åˆ" : "ç­‰å€™ä»–äºº...");

        renderHand();
        document.getElementById('players-info').innerHTML = gameState.players.map((p, i) => `
            <div class="player-box ${currentTurnIdx===i?'active':''} ${p.finished?'finished':''}">
                ${p.name}: ${p.cards.length}
            </div>
        `).join('');
        document.getElementById('table-cards').innerHTML = gameState.table.cards.map(c => `<div class="card ${c.suit==='â™¥'||c.suit==='â™¦'?'red':''}">${c.suit}${c.label}</div>`).join('');
        document.getElementById('table-info').innerText = gameState.table.type ? `${gameState.table.type} | ${gameState.table.rule}` : "é¦–å®¶å®šç¾©ç‰Œå‹";
    }

    function renderHand() {
        document.getElementById('my-hand').innerHTML = myCards.map((c, i) => `
            <div class="card my-card ${selectedIdxs.includes(i)?'selected':''} ${c.suit==='â™¥'||c.suit==='â™¦'?'red':''}" 
            onclick="toggleCard(${i})">${c.suit}${c.label}</div>`).join('');
    }

    function toggleCard(i) {
        if (selectedIdxs.includes(i)) selectedIdxs = selectedIdxs.filter(x => x !== i); else selectedIdxs.push(i);
        renderHand();
    }

    function sendAction(type, rule) {
        const sel = selectedIdxs.map(i => myCards[i]);
        const msg = { type, cards: sel, rule, peerId: isHost ? peer.id : myId };
        if (isHost) { if(type==='PLAY') autoJudge(msg); else nextTurn(); } else conn.send(msg);
        selectedIdxs = [];
    }

    function nextTurn() {
        let nextIdx = (currentTurnIdx + 1) % gameState.players.length;
        let startIdx = nextIdx;
        while (gameState.players[nextIdx].finished) {
            nextIdx = (nextIdx + 1) % gameState.players.length;
            if (nextIdx === startIdx) break;
        }
        currentTurnIdx = nextIdx;
        if (gameState.players[currentTurnIdx].id === gameState.table.leaderId) {
            gameState.table = { cards: [], power: -1, rule: "", type: null, leaderId: -1 };
        }
        broadcast({ type: 'UPDATE', gameState });
    }

    function broadcast(data) { connections.forEach(c => c.send(data)); handleData(data); }
    function log(m) { const l = document.getElementById('log'); l.innerHTML = `<div>> ${m}</div>` + l.innerHTML; }
    
    function revealNoumena(s) {
        const nc = document.getElementById('noumena-card');
        nc.innerText = s.suit + s.label; nc.className = 'reveal';
        if (s.suit==='â™¥'||s.suit==='â™¦') nc.style.color = 'red';
        log("ğŸŒ  å…¨å“¡å®Œè³½ï¼ŒçœŸå¯¦é¡¯ç¾ï¼");
        currentTurnIdx = -1; syncUI();
    }

    function copyID() {
        const id = document.getElementById('display-id').innerText;
        navigator.clipboard.writeText(id);
        alert("ID å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
    }
</script>
</body>
</html>
<style>
    /* é€™è£¡åªåˆ—å‡ºé—œéµä¿®æ”¹éƒ¨åˆ†ï¼Œå…¶é¤˜é‚è¼¯åŒä¸Š */
    body {
        /* ç¢ºä¿å…§å®¹æ°¸é åœ¨è¦–çª—æ­£ä¸­å¤® */
        display: flex;
        flex-direction: column;
        justify-content: center; 
        align-items: center;
        background: #000; /* èƒŒæ™¯å…¨é»‘èåˆ Sites */
    }

    /* é™åˆ¶éŠæˆ²ä¸»é«”æœ€å¤§å¯¬åº¦ï¼Œé¿å…é›»è…¦ç‰ˆæ©«å‘å¤ªæ•£ */
    .arena, .hand-zone, .dealer-bar {
        width: 100%;
        max-width: 600px; /* é›»è…¦ç‰ˆæœƒèšæ”åœ¨ä¸­é–“ï¼Œæ›´åƒæ‰‹æ©ŸéŠæˆ²ä»‹é¢ */
        margin: 0 auto;
    }
</style>
